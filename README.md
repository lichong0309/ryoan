Ryoan
=====

Ryoan is a distributed sandbox designed to confine untrusted code as it
operates on sensitive data. The sandbox is further protected by SGX so that the
even privileged software need not be trusted.

This code is intended as a proof-of-concept research prototype and should *not*
be used as is for security critical tasks.

Please take a look at our publications for more details about the design:
 * Tyler Hunt, Zhiting Zhu, Yuanzhong Xu, Simon Peter, and Emmett Witchel.
 Ryoan: A distributed sandbox for untrusted computation on secret data. In
 [OSDI 2016](https://www.usenix.org/conference/osdi16/technical-sessions/presentation/hunt)
 and [TOCS Dec 2018](https://dl.acm.org/doi/10.1145/3231594).

Ryoan is based on Google's
[Native Client](https://developer.chrome.com/native-client). Native Client
(NaCl) is a software sandbox that allows Ryoan to confine untrusted code. While
NaCl is usually connected to the Chrome browser it has been modified here to run
as a standalone process.

Ryoan is designed to run in SGX, but this prototype does not. Key features of
Ryoan such as checkpoint restore depend on SGX version 2 capabilities which have
yet to be released. To support execution in SGX Ryoan links NaCl to a modified
version of eglibc. Eglibc has been augmented here with marshalling code for all
system calls (take a look at `eglibc/sgx_syscall_interpos`).

Project Structure
-----------------
 - [`/native_client`](native_client) the Ryoan runtime
 - [`/naclports`](naclports) applications ported to Ryoan, and machinery to
 compile them using the nacl toolchain
 - [`/eglibc`](eglibc) libc modified to be compatible with SGX.
 - [`/naclports`](naclports) applications ported to Ryoan, and machinery to
 compile them using the nacl toolchain
 - [`/apps`](apps) workloads and external machinery required to make Ryoan work.
 E.g., IPC plumbing for pipelines, client programs.
 - [`/linux`](linux) linux kernel patches for SGX performance modeling

Prerequisites
--------------
  - Ubuntu 16.04 (may build on later versions but not tested)
  - Apt packages: `build-essential` `pv`

Configure
----------
Run `J=${Jobs} ./bootstrap.sh` in the root directory. This will unpack
`ryoan_env.tar.xz` and recursively configure other directories. This will also
build eglibc since it is required to configure other parts of Ryoan. The
environment variable `J` is passed directly to the `make` call for eglibc.

Build
-----
Each piece of Ryoan has a make file that will do the right thing after the
project is configured. Make commands should be run in the following order; some
pieces expect to be able to find headers generated by others.
  1. `cd native_client && make J=${n_jobs}` (make calls scons here so `-j` will
     do nothing).
  2. `cd naclports && make -j${n_jobs}`
  2. `cd apps && make -j${n_jobs}`
     do nothing).

Run
---
Running Ryoan requires a client program, a server program, and a pipeline
specification that details what modules should be loaded. These can all be found
in [`/apps`](apps). We've provided the scripts: `run_*_benchmark.sh` which
demonstrate how pipelines should be run and interacted with.
